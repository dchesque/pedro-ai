generator client {
  provider = "prisma-client-js"
  output   = "./generated/client_final"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String              @id @default(cuid())
  clerkId                   String              @unique
  email                     String?             @unique
  name                      String?
  isActive                  Boolean             @default(true)
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  asaasCustomerId           String?             @unique
  asaasCustomerIdSandbox    String?             @unique
  asaasCustomerIdProduction String?             @unique
  asaasSubscriptionId       String?
  currentPlanId             String?
  cpfCnpj                   String?
  billingPeriodEnd          DateTime?
  cancellationScheduled     Boolean             @default(false)
  cancellationDate          DateTime?
  characters                Character[]
  creditBalance             CreditBalance?
  shorts                    Short[]
  storageObjects            StorageObject[]
  styles                    Style[]
  subscriptionEvents        SubscriptionEvent[]
  climates                  Climate[]
  usageHistory              UsageHistory[]
  userAgents                UserAgent[]
  userStyles                UserStyle[]

  @@index([email])
  @@index([name])
  @@index([createdAt])
  @@index([isActive])
  @@index([currentPlanId])
}

model Feature {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  description String?
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
}

model CreditBalance {
  id               String         @id @default(cuid())
  userId           String         @unique
  clerkUserId      String         @unique
  creditsRemaining Int            @default(100)
  lastSyncedAt     DateTime       @default(now())
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  user             User           @relation(fields: [userId], references: [id])
  usageHistory     UsageHistory[]

  @@index([userId])
  @@index([clerkUserId])
  @@index([creditsRemaining])
  @@index([lastSyncedAt])
}

model UsageHistory {
  id              String        @id @default(cuid())
  userId          String
  creditBalanceId String
  operationType   OperationType
  creditsUsed     Int
  details         Json?
  timestamp       DateTime      @default(now())
  creditBalance   CreditBalance @relation(fields: [creditBalanceId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([creditBalanceId])
  @@index([timestamp])
  @@index([operationType])
  @@index([userId, timestamp])
  @@index([operationType, timestamp])
}

model Short {
  id               String           @id @default(cuid())
  userId           String
  clerkUserId      String
  title            String?
  theme            String
  targetDuration   Int              @default(30)
  style            String           @default("engaging")
  script           Json?
  hook             String?
  cta              String?
  status           ShortStatus      @default(DRAFT)
  progress         Int              @default(0)
  errorMessage     String?
  creditsUsed      Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  completedAt      DateTime?
  aiModel          String?          @default("deepseek/deepseek-v3.2")
  scriptApprovedAt DateTime?
  scriptVersion    Int              @default(1)
  summary          String?
  synopsis         String?
  styleId          String?
  fullNarration    String?
  premise          String?
  story            String?
  toneId           String?
  styleRelation    Style?           @relation(fields: [styleId], references: [id])
  climate          Climate?         @relation(fields: [climateId], references: [id]) 
  climateId        String?
  user             User             @relation(fields: [userId], references: [id])
  characters       ShortCharacter[]
  scenes           ShortScene[]

  @@index([userId])
  @@index([clerkUserId])
  @@index([status])
  @@index([createdAt])
}

model ShortScene {
  id             String         @id @default(cuid())
  shortId        String
  order          Int
  duration       Int            @default(5)
  narration      String?
  visualDesc     String?
  imagePrompt    String?
  negativePrompt String?
  mediaType      SceneMediaType @default(IMAGE)
  mediaUrl       String?
  mediaWidth     Int?
  mediaHeight    Int?
  isGenerated    Boolean        @default(false)
  errorMessage   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  visualPrompt   String?
  short          Short          @relation(fields: [shortId], references: [id], onDelete: Cascade)

  @@index([shortId])
  @@index([order])
}

model AdminSettings {
  id            String   @id @default("singleton")
  featureCosts  Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  defaultModels Json?
}

model Plan {
  id                String   @id @default(cuid())
  asaasId           String?  @unique
  clerkId           String?  @unique
  clerkName         String?
  name              String
  credits           Int
  active            Boolean  @default(true)
  sortOrder         Int      @default(0)
  currency          String?  @default("brl")
  priceMonthlyCents Int?
  priceYearlyCents  Int?
  description       String?
  features          Json?
  badge             String?
  highlight         Boolean  @default(false)
  ctaType           String?  @default("contact")
  ctaLabel          String?
  ctaUrl            String?
  billingSource     String   @default("manual")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([active])
  @@index([sortOrder])
}

model StorageObject {
  id          String    @id @default(cuid())
  userId      String
  clerkUserId String
  provider    String    @default("vercel_blob")
  url         String
  pathname    String
  name        String
  contentType String?
  size        Int
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([clerkUserId])
  @@index([contentType])
  @@index([deletedAt])
  @@index([name])
}

model SubscriptionEvent {
  id          String   @id @default(cuid())
  userId      String?
  clerkUserId String
  planKey     String?
  status      String
  eventType   String
  occurredAt  DateTime @default(now())
  metadata    Json?
  createdAt   DateTime @default(now())
  user        User?    @relation(fields: [userId], references: [id])

  @@index([clerkUserId, occurredAt])
  @@index([userId, occurredAt])
}

model GlobalAgent {
  id           String          @id @default(cuid())
  type         SystemAgentType @unique
  name         String
  description  String?
  systemPrompt String
  model        String          @default("anthropic/claude-3.5-sonnet")
  temperature  Float           @default(0.7)
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([type])
  @@index([isActive])
}

model UserAgent {
  id           String          @id @default(cuid())
  userId       String
  clerkUserId  String
  type         SystemAgentType
  name         String
  description  String?
  systemPrompt String
  model        String?
  temperature  Float?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
  @@index([clerkUserId])
  @@index([type])
}

model Agent {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String?
  icon            String?   // Emoji
  type            AgentType
  systemMessage   String    @db.Text
  questions       Json      // Array de perguntas
  outputFields    Json      // Campos do output
  validationRules Json?     // Regras de valida√ß√£o cruzada
  model           String    @default("deepseek/deepseek-chat")
  creditsPerUse   Int       @default(0)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model GlobalStyle {
  id                   String   @id @default(cuid())
  key                  String   @unique
  name                 String
  description          String?
  icon                 String?
  scriptwriterPrompt   String?
  promptEngineerPrompt String?
  visualStyle          String?
  negativePrompt       String?
  sortOrder            Int      @default(0)
  isActive             Boolean  @default(true)
  isDefault            Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([key])
  @@index([isActive])
  @@index([sortOrder])
}

model UserStyle {
  id                   String   @id @default(cuid())
  userId               String
  clerkUserId          String
  key                  String
  name                 String
  description          String?
  icon                 String?
  scriptwriterPrompt   String?
  promptEngineerPrompt String?
  visualStyle          String?
  negativePrompt       String?
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@index([userId])
  @@index([clerkUserId])
  @@index([key])
}

model Character {
  id                String           @id @default(cuid())
  userId            String
  clerkUserId       String
  name              String
  description       String?
  imageUrl          String
  thumbnailUrl      String?
  traits            Json?
  promptDescription String
  isActive          Boolean          @default(true)
  usageCount        Int              @default(0)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  shortCharacters   ShortCharacter[]

  @@index([userId])
  @@index([clerkUserId])
  @@index([isActive])
  @@index([usageCount])
}

model ShortCharacter {
  id             String    @id @default(cuid())
  shortId        String
  characterId    String
  role           String    @default("character")
  orderIndex     Int       @default(0)
  customPrompt   String?
  customClothing String?
  createdAt      DateTime  @default(now())
  character      Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  short          Short     @relation(fields: [shortId], references: [id], onDelete: Cascade)

  @@unique([shortId, characterId])
  @@index([shortId])
  @@index([characterId])
}

model Style {
  id                 String   @id @default(cuid())
  userId             String?
  name               String
  description        String?
  icon               String?  @default("üé¨")
  contentType        String   @default("story")
  scriptwriterPrompt String?
  narrativeStyle     String?
  languageStyle      String?
  exampleHook        String?
  exampleCta         String?
  visualPrompt       String?
  isDefault          Boolean  @default(false)
  isPublic           Boolean  @default(false)
  usageCount         Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  keywords           String[]
  suggestedClimateId    String?
  targetAudience     String?
  shorts             Short[]
  suggestedClimate   Climate?    @relation(fields: [suggestedClimateId], references: [id])
  user               User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
}

// Clima da narrativa
model Climate {
  id              String    @id @default(cuid())
  userId          String?   // Null = Sistema, ID = Pessoal
  
  name            String
  description     String?
  icon            String?   // Emoji
  behaviorPreview String?   // Preview do comportamento
  
  // Novos campos comportamentais v2.0
  emotionalState    EmotionalState    @default(CURIOSITY)
  revelationDynamic RevelationDynamic @default(PROGRESSIVE)
  narrativePressure NarrativePressure @default(FLUID)
  hookType          HookType          @default(QUESTION)
  closingType       ClosingType       @default(CTA_DIRECT)
  
  // Limites e Regras
  allowedRevelations Json?             // Array de revela√ß√µes permitidas
  allowedPressures   Json?             // Array de press√µes permitidas
  sentenceMaxWords   Int               @default(15)
  minScenes          Int               @default(3)
  maxScenes          Int               @default(15)

  // Instru√ß√µes para o agente (agora opcional para ajuste fino)
  promptFragment  String?    @db.Text 
  
  // Metadados
  isSystem        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Rela√ß√µes
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shorts          Short[]
  Style           Style[]
  
  @@unique([name, userId])
  @@index([userId])
  @@index([isSystem])
}

enum OperationType {
  AI_TEXT_CHAT
  AI_IMAGE_GENERATION
  FAL_IMAGE_GENERATION
  FAL_VIDEO_GENERATION
  SHORT_GENERATION
  SCRIPT_GENERATION
  SCRIPT_REGENERATION
  SCENE_REGENERATION
}

enum EmotionalState {
  CURIOSITY
  THREAT
  FASCINATION
  CONFRONTATION
  DARK_INSPIRATION
}

enum RevelationDynamic {
  PROGRESSIVE
  HIDDEN
  EARLY
  FRAGMENTS
}

enum NarrativePressure {
  SLOW
  FLUID
  FAST
}

enum HookType {
  QUESTION
  SHOCK
  CHALLENGE
  MYSTERY
  STATEMENT
}

enum ClosingType {
  CTA_DIRECT
  REVELATION
  QUESTION
  CHALLENGE
  LOOP
}

enum ShortStatus {
  DRAFT
  GENERATING_SCRIPT
  SCRIPT_READY
  SCRIPT_APPROVED
  GENERATING_IMAGES
  IMAGES_READY
  GENERATING_VIDEO
  VIDEO_READY
  PUBLISHED
  COMPLETED
  FAILED
}

enum SceneMediaType {
  IMAGE
  VIDEO
}

enum AgentType {
  CLIMATE
  STYLE
  CUSTOM
}

enum SystemAgentType {
  SCRIPTWRITER
  PROMPT_ENGINEER
  NARRATOR
}
