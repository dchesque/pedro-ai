// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "./generated/client_final"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String?  @unique
  name      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  creditBalance      CreditBalance?
  usageHistory       UsageHistory[]
  storageObjects     StorageObject[]
  subscriptionEvents SubscriptionEvent[]
  asaasCustomerId    String?   @unique
  asaasCustomerIdSandbox    String?   @unique
  asaasCustomerIdProduction String?   @unique
  asaasSubscriptionId String?
  currentPlanId      String?
  cpfCnpj            String?
  billingPeriodEnd      DateTime?
  cancellationScheduled Boolean  @default(false)
  cancellationDate      DateTime?

  @@index([email])
  @@index([name])
  @@index([createdAt])
  @@index([isActive])
  @@index([currentPlanId])
  shorts            Short[]
  userAgents        UserAgent[]
  userStyles        UserStyle[]
  characters        Character[]
}


// Workspace features and linkage to projects
model Feature {
  id          String     @id @default(cuid())
  workspaceId String
  name        String
  description String?
  tags        String[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
}

model CreditBalance {
  id                String   @id @default(cuid())
  userId            String   @unique
  clerkUserId       String   @unique
  creditsRemaining  Int      @default(100)  // Cached from Clerk
  lastSyncedAt      DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id])
  usageHistory      UsageHistory[]

  @@index([userId])
  @@index([clerkUserId])
  @@index([creditsRemaining])
  @@index([lastSyncedAt])
}

// Track individual usage events
model UsageHistory {
  id              String   @id @default(cuid())
  userId          String
  creditBalanceId String
  operationType   OperationType
  creditsUsed     Int
  details         Json?
  timestamp       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id])
  creditBalance   CreditBalance @relation(fields: [creditBalanceId], references: [id])

  @@index([userId])
  @@index([creditBalanceId])
  @@index([timestamp])
  @@index([operationType])
  @@index([userId, timestamp])
  @@index([operationType, timestamp])
}

enum OperationType {
  AI_TEXT_CHAT
  AI_IMAGE_GENERATION
  FAL_IMAGE_GENERATION
  FAL_VIDEO_GENERATION
  SHORT_GENERATION
  SCRIPT_GENERATION
  SCRIPT_REGENERATION
  SCENE_REGENERATION
}

// Status do Short
enum ShortStatus {
  DRAFT              // Rascunho inicial (s√≥ tema/config)
  GENERATING_SCRIPT  // Gerando roteiro
  SCRIPT_READY       // Roteiro pronto - aguardando aprova√ß√£o do usu√°rio
  SCRIPT_APPROVED    // Roteiro aprovado - pronto para gerar m√≠dia
  GENERATING_PROMPTS // Gerando prompts de imagem
  GENERATING_MEDIA   // Gerando imagens
  COMPLETED          // Conclu√≠do
  FAILED             // Falhou
}

// Tipo de m√≠dia da cena
enum SceneMediaType {
  IMAGE           // Imagem est√°tica
  VIDEO           // V√≠deo animado
}

// Short principal
model Short {
  id              String       @id @default(cuid())
  userId          String
  clerkUserId     String
  
  // Input do usu√°rio
  title           String?      // T√≠tulo (preenchido ap√≥s roteiro)
  theme           String       // Tema/nicho do short
  targetDuration  Int          @default(30)  // Dura√ß√£o alvo em segundos
  style           String       @default("engaging") // Estilo (engaging, educational, funny, etc)
  
  // Novo: Modelo de IA escolhido pelo usu√°rio
  aiModel           String?     @default("deepseek/deepseek-v3.2")

  // Novo: Resumo da hist√≥ria (gerado junto com roteiro)
  summary           String?     @db.Text
  
  // Roteiro gerado
  script          Json?        // Roteiro completo em JSON
  hook            String?      // Gancho inicial
  cta             String?      // Call to action final
  
  // Novo: Vers√£o do roteiro (para hist√≥rico futuro)
  scriptVersion     Int         @default(1)
  
  // Status e progresso
  status          ShortStatus  @default(DRAFT)
  progress        Int          @default(0)    // 0-100
  errorMessage    String?
  
  // Novo: Data de aprova√ß√£o do roteiro
  scriptApprovedAt  DateTime?

  // Custos
  creditsUsed     Int          @default(0)
  
  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  completedAt     DateTime?
  
  // Relations
  user            User         @relation(fields: [userId], references: [id])
  scenes          ShortScene[]
  characters      ShortCharacter[]
  
  @@index([userId])
  @@index([clerkUserId])
  @@index([status])
  @@index([createdAt])
}

// Cena do Short
model ShortScene {
  id              String         @id @default(cuid())
  shortId         String
  
  // Ordem e timing
  order           Int            // Ordem da cena (0, 1, 2...)
  duration        Int            @default(5)  // Dura√ß√£o em segundos
  
  // Conte√∫do do roteiro
  narration       String?        // Texto de narra√ß√£o
  visualDesc      String?        // Descri√ß√£o visual do roteiro
  
  // Prompts gerados
  imagePrompt     String?        // Prompt para imagem
  negativePrompt  String?        // Negative prompt
  
  // M√≠dia gerada
  mediaType       SceneMediaType @default(IMAGE)
  mediaUrl        String?        // URL da imagem/v√≠deo gerado
  mediaWidth      Int?
  mediaHeight     Int?
  
  // Status
  isGenerated     Boolean        @default(false)
  errorMessage    String?
  
  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  short           Short          @relation(fields: [shortId], references: [id], onDelete: Cascade)
  
  @@index([shortId])
  @@index([order])
}

// Singleton row storing admin-configurable credit settings
model AdminSettings {
  id           String   @id @default("singleton")
  featureCosts Json?
  defaultModels Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Subscription plans managed manually and optionally linked to payment providers
model Plan {
  id        String   @id @default(cuid())
  asaasId   String?  @unique // Asaas plan ID for payment processing
  clerkId   String?  @unique // Legacy Clerk plan ID (deprecated)
  clerkName String?  // Legacy field
  name      String
  credits   Int
  active    Boolean  @default(true)
  sortOrder Int      @default(0)
  // Pricing configuration (amounts in cents)
  // Asaas only supports BRL (Brazilian Real)
  currency           String?  @default("brl")
  priceMonthlyCents  Int?
  priceYearlyCents   Int?
  description        String?  @db.Text
  features           Json?
  badge              String?
  highlight          Boolean  @default(false)
  ctaType            String?  @default("contact")
  ctaLabel           String?
  ctaUrl             String?
  billingSource      String   @default("manual")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
  @@index([sortOrder])
}

// File/object uploads tracked for admin management
model StorageObject {
  id           String   @id @default(cuid())
  userId       String
  clerkUserId  String
  provider     String   @default("vercel_blob")
  url          String
  pathname     String
  name         String
  contentType  String?
  size         Int
  deletedAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([clerkUserId])
  @@index([contentType])
  @@index([deletedAt])
  @@index([name])
}

// Track subscription lifecycle events for revenue analytics
model SubscriptionEvent {
  id           String   @id @default(cuid())
  userId       String?
  clerkUserId  String
  planKey      String?
  status       String
  eventType    String
  occurredAt   DateTime @default(now())
  metadata     Json?
  createdAt    DateTime @default(now())

  user         User?    @relation(fields: [userId], references: [id])

  @@index([clerkUserId, occurredAt])
  @@index([userId, occurredAt])
}

// ============================================
// SISTEMA DE AGENTES E ESTILOS CONFIGUR√ÅVEIS
// ============================================

// Tipo de agente
enum AgentType {
  SCRIPTWRITER      // Roteirista - cria roteiros
  PROMPT_ENGINEER   // Engenheiro de Prompts - cria prompts de imagem
  NARRATOR          // Narrador (futuro - ElevenLabs)
}

// Agente Global (Admin) - fallback para todos os usu√°rios
model GlobalAgent {
  id              String      @id @default(cuid())
  type            AgentType   @unique  // Apenas 1 por tipo
  name            String
  description     String?
  systemPrompt    String      @db.Text
  model           String      @default("anthropic/claude-3.5-sonnet")
  temperature     Float       @default(0.7)
  isActive        Boolean     @default(true)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([type])
  @@index([isActive])
}

// Agente do Usu√°rio - sobrep√µe o global se existir
model UserAgent {
  id              String      @id @default(cuid())
  userId          String
  clerkUserId     String
  type            AgentType
  name            String
  description     String?
  systemPrompt    String      @db.Text
  model           String?     // Se null, usa o do global ou default
  temperature     Float?
  isActive        Boolean     @default(true)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, type])  // 1 agente por tipo por usu√°rio
  @@index([userId])
  @@index([clerkUserId])
  @@index([type])
}

// Estilo Global (Admin) - dispon√≠vel para todos
model GlobalStyle {
  id              String      @id @default(cuid())
  key             String      @unique  // ex: "engaging", "educational", "tech_review"
  name            String               // ex: "Envolvente", "Educacional"
  description     String?              // Descri√ß√£o para UI
  icon            String?              // Emoji ou nome do √≠cone (ex: "üî•", "Flame")
  
  // Prompts adicionais injetados no agente
  scriptwriterPrompt    String?   @db.Text  // Adicional para o roteirista
  promptEngineerPrompt  String?   @db.Text  // Adicional para prompt engineer
  
  // Configura√ß√µes visuais para gera√ß√£o de imagem
  visualStyle     String?     @db.Text  // Ex: "cinematic, dramatic lighting, 8k"
  negativePrompt  String?     @db.Text  // Ex: "cartoon, anime, low quality"
  
  sortOrder       Int         @default(0)
  isActive        Boolean     @default(true)
  isDefault       Boolean     @default(false)  // Estilo padr√£o selecionado
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([key])
  @@index([isActive])
  @@index([sortOrder])
}

// Estilo do Usu√°rio - customiza√ß√£o pessoal
model UserStyle {
  id              String      @id @default(cuid())
  userId          String
  clerkUserId     String
  
  key             String      // ex: "meu_estilo_gaming", "reviews_tech"
  name            String
  description     String?
  icon            String?
  
  // Prompts adicionais
  scriptwriterPrompt    String?   @db.Text
  promptEngineerPrompt  String?   @db.Text
  
  // Configura√ß√µes visuais
  visualStyle     String?     @db.Text
  negativePrompt  String?     @db.Text
  
  isActive        Boolean     @default(true)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, key])  // Key √∫nica por usu√°rio
  @@index([userId])
  @@index([clerkUserId])
  @@index([key])
}

// ============================================
// SISTEMA DE BIBLIOTECA DE PERSONAGENS
// ============================================

model Character {
  id                String   @id @default(cuid())
  userId            String
  clerkUserId       String
  
  // Informa√ß√µes b√°sicas
  name              String              // "Maria"
  description       String?  @db.Text   // Descri√ß√£o livre
  
  // Imagem de refer√™ncia
  imageUrl          String              // URL da imagem uploaded
  thumbnailUrl      String?             // Vers√£o menor para listagem
  
  // Caracter√≠sticas f√≠sicas (JSON estruturado)
  traits            Json?
  // Estrutura sugerida:
  // {
  //   "age": "6 anos",
  //   "gender": "female",
  //   "hairColor": "castanho",
  //   "hairStyle": "rabo de cavalo",
  //   "skinTone": "clara",
  //   "eyeColor": "castanho",
  //   "clothing": "vestido rosa",
  //   "accessories": "la√ßo vermelho",
  //   "bodyType": "crian√ßa magra",
  //   "distinctiveFeatures": "sardas no rosto"
  // }
  
  // Prompt otimizado (gerado automaticamente ou editado pelo usu√°rio)
  promptDescription String   @db.Text   // Prompt em ingl√™s otimizado para IA
  
  // Metadados
  isActive          Boolean  @default(true)
  usageCount        Int      @default(0)  // Quantos shorts usaram este personagem
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shortCharacters   ShortCharacter[]
  
  @@index([userId])
  @@index([clerkUserId])
  @@index([isActive])
  @@index([usageCount])
}

model ShortCharacter {
  id            String    @id @default(cuid())
  shortId       String
  characterId   String
  
  // Papel no short
  role          String    @default("character")  // "protagonist", "sidekick", "antagonist", "supporting"
  orderIndex    Int       @default(0)            // Ordem de import√¢ncia/apari√ß√£o
  
  // Customiza√ß√£o para este short espec√≠fico (opcional)
  customPrompt  String?   @db.Text               // Override do prompt para este short
  customClothing String?                          // Roupa diferente neste short
  
  createdAt     DateTime  @default(now())
  
  // Relations
  short         Short     @relation(fields: [shortId], references: [id], onDelete: Cascade)
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  @@unique([shortId, characterId])  // Mesmo personagem n√£o pode ser adicionado 2x
  @@index([shortId])
  @@index([characterId])
}
